<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eisenhower Matrix (Confirm → Settle → WebAR)</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <script type="text/plain" data-kept="true"
    src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --pink:#f7d6d9;
      --yellow:#f6e6a8;
      --cream:#fbf7e9;
      --border:#1f1f1f;
      --text:#111;
      --muted:#666;
      --btn:#b9ff9e;
      --btnDisabled:#d9d9d9;
      --btnText:#0b0b0b;
      --danger:#ff5a5a;
      --blue:#0b51ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}

    .app{
      height:100%;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      padding-top: calc(14px + env(safe-area-inset-top));
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width:420px;
      margin:0 auto;
    }
    .view{display:none; height:100%;}
    .view.active{display:flex; flex-direction:column; gap:12px;}

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      min-height: 28px;
    }
    .textBtn{
      appearance:none;
      border:none;
      background:transparent;
      padding:0;
      font: inherit;
      cursor:pointer;
      color: var(--text);
    }
    .textBtn:disabled{ opacity:.4; cursor:not-allowed; }
    .textBtn.back{ font-weight:700; color: rgba(0,0,0,.85); }
    .textBtn.danger{ font-weight:900; color: var(--danger); }

    .matrix{
      flex:1;
      border:1px solid var(--border);
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap:0;
    }
    .quad{
      padding:10px;
      font-size:12px;
      line-height:1.2;
      position:relative;
      overflow:hidden;
      border-right:1px solid rgba(0,0,0,.12);
      border-bottom:1px solid rgba(0,0,0,.12);
      cursor:pointer;
    }
    .quad:nth-child(2), .quad:nth-child(4){ border-right:none; }
    .quad:nth-child(3), .quad:nth-child(4){ border-bottom:none; }

    .quad.pink{ background: var(--pink); }
    .quad.yellow{ background: var(--yellow); }
    .quad.cream{ background: var(--cream); }

    .quadTitle{ font-weight:600; margin-bottom:8px; }
    .preview{ display:flex; flex-direction:column; gap:6px; margin-top:4px; }
    .previewItem{
      font-size:11px;
      color: rgba(0,0,0,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .previewItem.done{ text-decoration: line-through; color: rgba(0,0,0,.45); }

    .bottomBar{
      display:flex;
      justify-content:center;
      padding-top:6px;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }

    .primaryBtn{
      width: min(360px, 100%);
      height: 56px;
      border:none;
      border-radius:14px;
      background: var(--btn);
      color: var(--btnText);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .primaryBtn:disabled{
      background: var(--btnDisabled);
      color: rgba(0,0,0,.45);
      cursor:not-allowed;
    }

    .tinyNote{
      font-size:12px;
      color: var(--muted);
      text-align:center;
      min-height:16px;
      line-height:1.25;
    }

    .catPanel{
      flex:1;
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      background: var(--pink);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .catPanel.yellowBg{ background: var(--yellow); }
    .catPanel.creamBg{ background: var(--cream); }

    .catHeader{
      font-size:22px;
      font-weight:800;
      line-height:1.05;
      margin-bottom:10px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1;
      padding-right:2px;
    }

    .swipeWrap{ position:relative; overflow:hidden; border-radius:10px; }
    .deleteBg{
      position:absolute;
      inset:0;
      background: var(--danger);
      display:flex;
      justify-content:flex-end;
      align-items:center;
      padding-right:12px;
      color:#fff;
      font-weight:800;
      pointer-events:none;
    }
    .row{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.18);
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transform: translateX(0px);
      transition: transform .15s ease;
      touch-action: pan-y;
      border-radius:10px;
    }
    .textBox{ flex:1; min-width:0; display:flex; flex-direction:column; gap:4px; }
    .textView{
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:2px 4px;
    }
    .editInput{
      width:100%;
      font-size:12px;
      padding:6px 6px;
      border:1px solid rgba(0,0,0,.25);
      background: rgba(255,255,255,.9);
      outline:none;
      display:none;
      border-radius:8px;
    }

    .rowCheck{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.18);
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-radius:10px;
    }
    .rowCheck.done .checkText{ text-decoration: line-through; color: rgba(0,0,0,.45); }
    .checkText{
      flex:1;
      min-width:0;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:2px 4px;
    }

    .switch{ position:relative; width:38px; height:22px; flex:0 0 auto; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.18);
      border-radius:999px;
      transition:.18s;
    }
    .slider:before{
      content:"";
      position:absolute;
      width:16px; height:16px;
      left:3px; top:2px;
      background:#cfcfcf;
      border-radius:50%;
      transition:.18s;
    }
    .switch input:checked + .slider{ background: rgba(95,215,120,.55); }
    .switch input:checked + .slider:before{ transform: translateX(16px); background:#fff; }

    .fab{
      position:absolute;
      left:50%;
      bottom:64px;
      transform: translateX(-50%);
      width:56px;
      height:56px;
      border-radius:999px;
      border:none;
      background:#fff;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
      font-size:30px;
      line-height:56px;
      text-align:center;
      cursor:pointer;
    }
    .fab:disabled{ opacity:.35; cursor:not-allowed; }

    .settlePanel{
      flex:1;
      border:1px solid var(--border);
      background: var(--cream);
      padding:12px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border-radius:10px;
    }
    .settleHeader{
      font-size:20px;
      font-weight:900;
      line-height:1.05;
      margin-bottom:6px;
    }
    .settleSub{
      font-size:12px;
      color: rgba(0,0,0,.62);
      line-height:1.25;
      margin-bottom:10px;
    }
    .groupTitle{
      font-size:12px;
      font-weight:900;
      margin: 10px 0 6px;
      opacity:.75;
    }

    #arOverlay{
      position:fixed;
      inset:0;
      background:#000;
      z-index:9999;
      display:none;
      color:#fff;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      padding-top: calc(18px + env(safe-area-inset-top));
    }
    #arOverlay.show{ display:flex; flex-direction:column; gap:12px; }

    #arSceneWrap{ position:absolute; inset:0; z-index:0; }
    #arScene{
      position:absolute !important;
      inset:0 !important;
      width:100% !important;
      height:100% !important;
    }
    #arScene canvas{ width:100% !important; height:100% !important; }

    #arHud{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100%;
      pointer-events:none;
    }
    .arTitle{ font-size:20px; font-weight:900; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
    .arHint{ font-size:13px; opacity:.95; line-height:1.3; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
    .arSpacer{ flex:1; }
    .arDone{
      height:44px;
      border:none;
      background:#fff;
      color: var(--blue);
      font-weight:900;
      cursor:pointer;
      border-radius:12px;
      pointer-events:auto;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- MATRIX VIEW -->
    <section id="matrixView" class="view active">
      <div class="topBar">
        <div></div>
        <button id="newRoundBtnTop" class="textBtn danger" style="display:none;">New Round</button>
      </div>

      <div class="matrix" id="matrixGrid">
        <div class="quad pink" data-cat="IU">
          <div class="quadTitle">Urgent,<br>Important</div>
          <div class="preview" id="previewIU"></div>
        </div>
        <div class="quad pink" data-cat="IN">
          <div class="quadTitle">Not Urgent,<br>Important</div>
          <div class="preview" id="previewIN"></div>
        </div>
        <div class="quad yellow" data-cat="NU">
          <div class="quadTitle">Urgent,<br>Not Important</div>
          <div class="preview" id="previewNU"></div>
        </div>
        <div class="quad cream" data-cat="NN">
          <div class="quadTitle">Not Urgent,<br>Not Important</div>
          <div class="preview" id="previewNN"></div>
        </div>
      </div>

      <div class="bottomBar">
        <button id="mainBtn" class="primaryBtn" disabled>Confirm</button>
      </div>

      <div class="tinyNote" id="mainNote"></div>
    </section>

    <!-- CATEGORY VIEW -->
    <section id="catView" class="view">
      <div class="topBar">
        <button id="backBtn" class="textBtn back">← Back</button>
        <div></div>
      </div>

      <div id="catPanel" class="catPanel">
        <div class="catHeader" id="catHeader">Urgent,<br>Important</div>
        <div class="list" id="catList"></div>
        <button id="fabAdd" class="fab" title="Add">+</button>
      </div>
    </section>

    <!-- SETTLEMENT VIEW -->
    <section id="settleView" class="view">
      <div class="topBar">
        <button id="settleBackBtn" class="textBtn back">← Back</button>
        <button id="settleNewRoundText" class="textBtn danger" style="display:none;">New Round</button>
      </div>

      <div class="settlePanel">
        <div class="settleHeader">Settlement</div>
        <div class="settleSub" id="settleNote">Mark done → AR.</div>
        <div class="list" id="settleList"></div>
      </div>

      <div class="bottomBar">
        <button id="settleGoBtn" class="primaryBtn">View AR</button>
        <button id="settleRewatchBtn" class="primaryBtn" style="display:none;">Rewatch AR</button>
      </div>
    </section>

  </div>

  <!-- WebAR Overlay -->
  <div id="arOverlay">
    <div id="arSceneWrap">
      <a-scene
        id="arScene"
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true, physicallyCorrectLights: true"
        embedded
      >
        <a-entity light="type: ambient; intensity: 0.85"></a-entity>
        <a-entity light="type: directional; intensity: 0.7" position="0 1 0.8"></a-entity>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="arTarget0" mindar-image-target="targetIndex: 0">
          <a-entity id="ballRoot"></a-entity>
        </a-entity>
      </a-scene>
    </div>

    <div id="arHud">
      <div class="arTitle">AR</div>
      <div class="arHint" id="arHint">Point at target.</div>
      <div class="arSpacer"></div>
      <button id="arDoneBtn" class="arDone">Done</button>
    </div>
  </div>

<script>
  const STORAGE_KEY = "eisen_matrix_v4_state";
  const MODE_KEY    = "eisen_matrix_v4_mode";
  const ROUND_KEY   = "eisen_matrix_v4_round";

  const MODE = { PLAN:"plan", CHECK:"check" };
  const MAX_PER_CAT = 3;

  const CATS = ["IU","IN","NU","NN"];
  const CAT_META = {
    IU: { title: "Urgent,<br>Important", bg: "pink" },
    IN: { title: "Not Urgent,<br>Important", bg: "pink" },
    NU: { title: "Urgent,<br>Not Important", bg: "yellow" },
    NN: { title: "Not Urgent,<br>Not Important", bg: "cream" }
  };

  let state = loadState();
  let mode  = loadMode();
  let round = loadRound();
  let currentCat = null;

  function cryptoId(){
    return (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(16).slice(2));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { IU:[], IN:[], NU:[], NN:[] };
      const parsed = JSON.parse(raw);
      for (const c of CATS) if (!Array.isArray(parsed[c])) parsed[c] = [];
      for (const c of CATS){
        parsed[c] = parsed[c].map(t => ({
          id: t.id || cryptoId(),
          text: typeof t.text === "string" ? t.text : "",
          done: !!t.done
        })).slice(0, MAX_PER_CAT);
      }
      return parsed;
    }catch{
      return { IU:[], IN:[], NU:[], NN:[] };
    }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function loadMode(){
    const m = localStorage.getItem(MODE_KEY);
    return (m === MODE.CHECK) ? MODE.CHECK : MODE.PLAN;
  }
  function saveMode(){ localStorage.setItem(MODE_KEY, mode); }

  function loadRound(){
    try{
      const raw = localStorage.getItem(ROUND_KEY);
      if (!raw) return null;
      const r = JSON.parse(raw);
      if (!r || typeof r.id !== "string") return null;
      return {
        id: r.id,
        settledAt: (typeof r.settledAt === "number") ? r.settledAt : null,
        snapshot: r.snapshot || null
      };
    }catch{ return null; }
  }
  function saveRound(){
    if (!round) localStorage.removeItem(ROUND_KEY);
    else localStorage.setItem(ROUND_KEY, JSON.stringify(round));
  }
  function isRoundSettled(){ return !!round?.settledAt; }
  function startRound(){ round = { id: cryptoId(), settledAt: null, snapshot: null }; saveRound(); }
  function settleRound(snapshot){
    if (!round) startRound();
    round.settledAt = Date.now();
    round.snapshot = snapshot || null;
    saveRound();
  }
  function clearRound(){ round = null; saveRound(); }

  if (mode === MODE.CHECK && !round) startRound();

  function allTasks(){ return CATS.flatMap(c => state[c]); }
  function totalTasks(){ return allTasks().length; }
  function completedCount(){ return allTasks().reduce((a,t)=>a+(t.done?1:0),0); }
  function incompleteCount(){ return totalTasks() - completedCount(); }
  function completionRatio(){
    const total = totalTasks();
    return total ? (completedCount()/total) : 0;
  }

  /***********************
   * Outcome logic (UPDATED)
   * - Only2 -> chill
   * - Else: ratio >= 2/3 -> celebrate
   * - Else (including 1/3~2/3) -> fall
   ***********************/
  function computeOutcomeAndCount(){
    const total = totalTasks();
    const done = completedCount();
    const undone = total - done;

    const hasNon2 = (state.IU.length + state.IN.length + state.NU.length) > 0;
    const only2 = (!hasNon2) && (state.NN.length > 0);

    const ratio = completionRatio();

    let outcome;
    if (only2){
      outcome = "chill";
    } else {
      outcome = (ratio >= (2/3)) ? "celebrate" : "fall";
    }

    let nBalls = (outcome === "fall") ? (undone * 3) : (done * 3);
    nBalls = Math.min(nBalls, 60);

    return { outcome, nBalls, total, done, undone, ratio, only2 };
  }

  /***********************
   * AR balls generator
   ***********************/
  const ballRoot = document.getElementById("ballRoot");
  function clearBalls(){
    if (!ballRoot) return;
    while (ballRoot.firstChild) ballRoot.removeChild(ballRoot.firstChild);
  }
  function rand(min,max){ return min + Math.random()*(max-min); }
  function randInt(min,max){ return Math.floor(rand(min,max+1)); }
  function randomBrightColor(){
    const palette = ["#ff3b30","#ff9500","#ffcc00","#34c759","#5ac8fa","#007aff","#5856d6","#ff2d55"];
    return palette[randInt(0, palette.length-1)];
  }

  function addBallCelebrate(){
    const s = document.createElement("a-sphere");
    s.setAttribute("radius", rand(0.035, 0.055).toFixed(3));
    s.setAttribute("material", `color: ${randomBrightColor()}; metalness: 0.95; roughness: 0.18`);

    const x = rand(-0.18, 0.18);
    const z = rand(0.05, 0.28);
    const baseY = rand(-0.05, 0.08);
    s.setAttribute("position", `${x.toFixed(3)} ${baseY.toFixed(3)} ${z.toFixed(3)}`);

    const jump = rand(0.08, 0.18);
    const dur1 = randInt(700, 1200);
    const delay = randInt(0, 600);
    s.setAttribute("animation__jump",
      `property: position; dir: alternate; dur: ${dur1}; delay: ${delay}; loop: true; easing: easeInOutSine; to: ${x.toFixed(3)} ${(baseY+jump).toFixed(3)} ${z.toFixed(3)}`);

    const dur2 = randInt(900, 1600);
    const rotA = rand(-18, 18);
    const rotB = -rotA;
    s.setAttribute("rotation", `0 0 ${rotA.toFixed(1)}`);
    s.setAttribute("animation__rock",
      `property: rotation; dir: alternate; dur: ${dur2}; delay: ${delay}; loop: true; easing: easeInOutSine; to: 0 0 ${rotB.toFixed(1)}`);

    return s;
  }

  function addBallFall(){
    const s = document.createElement("a-sphere");
    s.setAttribute("radius", rand(0.040, 0.060).toFixed(3));
    s.setAttribute("material", `color: #7a7a7a; metalness: 0.0; roughness: 1.0`);

    const x = rand(-0.22, 0.22);
    const z = rand(0.06, 0.30);
    const startY = rand(0.18, 0.45);
    const endY = rand(-0.45, -0.25);

    s.setAttribute("position", `${x.toFixed(3)} ${startY.toFixed(3)} ${z.toFixed(3)}`);

    const dur = randInt(700, 1400);
    const delay = randInt(0, 700);

    s.setAttribute("animation__fall",
      `property: position; dur: ${dur}; delay: ${delay}; loop: true; easing: easeInQuad; to: ${(x + rand(-0.05,0.05)).toFixed(3)} ${endY.toFixed(3)} ${(z + rand(-0.03,0.03)).toFixed(3)}`);

    const spinDur = randInt(900, 1600);
    s.setAttribute("animation__spin",
      `property: rotation; dur: ${spinDur}; delay: ${delay}; loop: true; easing: linear; to: ${randInt(180, 540)} ${randInt(180, 540)} ${randInt(180, 540)}`);

    s.addEventListener("animationcomplete__fall", () => {
      const nx = rand(-0.22, 0.22);
      const nz = rand(0.06, 0.30);
      const ny = rand(0.18, 0.45);
      s.setAttribute("position", `${nx.toFixed(3)} ${ny.toFixed(3)} ${nz.toFixed(3)}`);
      s.setAttribute("animation__fall",
        `property: position; dur: ${dur}; delay: ${delay}; loop: true; easing: easeInQuad; to: ${(nx + rand(-0.05,0.05)).toFixed(3)} ${endY.toFixed(3)} ${(nz + rand(-0.03,0.03)).toFixed(3)}`);
    });

    return s;
  }

  function addBallChill(){
    const s = document.createElement("a-sphere");
    s.setAttribute("radius", rand(0.038, 0.055).toFixed(3));
    s.setAttribute("material", `color: #7fffe2; metalness: 0.85; roughness: 0.25`);

    const x0 = rand(-0.18, 0.18);
    const z0 = rand(0.07, 0.28);
    const y0 = rand(-0.02, 0.12);
    s.setAttribute("position", `${x0.toFixed(3)} ${y0.toFixed(3)} ${z0.toFixed(3)}`);

    const dx = rand(0.03, 0.09) * (Math.random()<0.5?-1:1);
    const dy = rand(0.02, 0.06);
    const dz = rand(0.02, 0.06) * (Math.random()<0.5?-1:1);

    const dur = randInt(1400, 2400);
    const delay = randInt(0, 700);

    s.setAttribute("animation__drift",
      `property: position; dir: alternate; dur: ${dur}; delay: ${delay}; loop: true; easing: easeInOutSine; to: ${(x0+dx).toFixed(3)} ${(y0+dy).toFixed(3)} ${(z0+dz).toFixed(3)}`);

    const dur2 = randInt(1800, 3200);
    s.setAttribute("animation__tilt",
      `property: rotation; dir: alternate; dur: ${dur2}; delay: ${delay}; loop: true; easing: easeInOutSine; to: ${rand(-12,12).toFixed(1)} ${rand(-20,20).toFixed(1)} ${rand(-12,12).toFixed(1)}`);

    return s;
  }

  function buildARVisual(snapshot){
    clearBalls();
    if (!ballRoot) return;

    for (let i=0; i<snapshot.nBalls; i++){
      let ball;
      if (snapshot.outcome === "celebrate") ball = addBallCelebrate();
      else if (snapshot.outcome === "fall") ball = addBallFall();
      else ball = addBallChill();
      ballRoot.appendChild(ball);
    }
  }

  /***********************
   * Views
   ***********************/
  const matrixView = document.getElementById("matrixView");
  const catView    = document.getElementById("catView");
  const settleView = document.getElementById("settleView");

  const catHeader  = document.getElementById("catHeader");
  const catList    = document.getElementById("catList");
  const catPanel   = document.getElementById("catPanel");
  const fabAdd     = document.getElementById("fabAdd");

  const backBtn     = document.getElementById("backBtn");
  const mainBtn     = document.getElementById("mainBtn");
  const mainNote    = document.getElementById("mainNote");
  const newRoundBtnTop = document.getElementById("newRoundBtnTop");

  const settleList    = document.getElementById("settleList");
  const settleNote    = document.getElementById("settleNote");
  const settleBackBtn = document.getElementById("settleBackBtn");
  const settleGoBtn   = document.getElementById("settleGoBtn");
  const settleRewatchBtn = document.getElementById("settleRewatchBtn");
  const settleNewRoundText = document.getElementById("settleNewRoundText");

  function showMatrix(){
    currentCat = null;
    catView.classList.remove("active");
    settleView.classList.remove("active");
    matrixView.classList.add("active");
    renderMatrix();
  }
  function showCategory(cat){
    currentCat = cat;
    matrixView.classList.remove("active");
    settleView.classList.remove("active");
    catView.classList.add("active");

    catHeader.innerHTML = CAT_META[cat].title;
    catPanel.classList.remove("yellowBg","creamBg");
    if (CAT_META[cat].bg === "yellow") catPanel.classList.add("yellowBg");
    if (CAT_META[cat].bg === "cream")  catPanel.classList.add("creamBg");

    renderCategory(cat);
  }
  function showSettlement(){
    matrixView.classList.remove("active");
    catView.classList.remove("active");
    settleView.classList.add("active");
    renderSettlement();
  }

  backBtn.addEventListener("click", showMatrix);
  settleBackBtn.addEventListener("click", showMatrix);

  document.getElementById("matrixGrid").addEventListener("click", (e) => {
    const quad = e.target.closest(".quad");
    if (!quad) return;
    showCategory(quad.dataset.cat);
  });

  function renderMatrix(){
    for (const cat of CATS){
      const box = document.getElementById("preview"+cat);
      box.innerHTML = "";
      const items = state[cat].slice(0,3);
      for (const t of items){
        const div = document.createElement("div");
        div.className = "previewItem" + (t.done ? " done" : "");
        div.textContent = "• " + (t.text || "(empty)");
        box.appendChild(div);
      }
    }

    if (mode === MODE.PLAN){
      newRoundBtnTop.style.display = "none";
      const canConfirm = totalTasks() > 0;
      mainBtn.textContent = "Confirm";
      mainBtn.disabled = !canConfirm;
      mainNote.textContent = canConfirm ? `Max ${MAX_PER_CAT}/cat.` : "Add 1+ todo.";
    } else {
      const settled = isRoundSettled();
      const hasTasks = totalTasks() > 0;

      newRoundBtnTop.style.display = settled ? "inline-block" : "none";

      mainBtn.textContent = settled ? "Settled ✅" : "Settle";
      mainBtn.disabled = !hasTasks || settled;
      mainNote.textContent = !hasTasks ? "No todos." : (settled ? "Settled. You can rewatch AR." : "Settle once → AR.");
    }
  }

  function renderCategory(cat){
    catList.innerHTML = "";

    if (mode === MODE.PLAN){
      fabAdd.style.display = "block";
      fabAdd.disabled = state[cat].length >= MAX_PER_CAT;

      for (const task of state[cat]){
        const wrap = document.createElement("div");
        wrap.className = "swipeWrap";

        const delBg = document.createElement("div");
        delBg.className = "deleteBg";
        delBg.textContent = "Delete";
        wrap.appendChild(delBg);

        const row = document.createElement("div");
        row.className = "row";
        row.dataset.id = task.id;

        const textBox = document.createElement("div");
        textBox.className = "textBox";

        const textView = document.createElement("div");
        textView.className = "textView";
        textView.textContent = task.text || "tap to edit";

        const edit = document.createElement("input");
        edit.className = "editInput";
        edit.type = "text";
        edit.value = task.text || "";

        textView.addEventListener("click", () => {
          textView.style.display = "none";
          edit.style.display = "block";
          edit.focus();
          edit.setSelectionRange(edit.value.length, edit.value.length);
        });

        function commitEdit(){
          const v = edit.value.trim();
          task.text = v;
          textView.textContent = v || "tap to edit";
          edit.style.display = "none";
          textView.style.display = "block";
          persistAndRerender(cat);
        }
        edit.addEventListener("keydown", (e) => { if (e.key === "Enter") edit.blur(); });
        edit.addEventListener("blur", commitEdit);

        textBox.appendChild(textView);
        textBox.appendChild(edit);

        row.appendChild(textBox);
        wrap.appendChild(row);
        catList.appendChild(wrap);

        attachSwipeToDelete(row, () => {
          state[cat] = state[cat].filter(t => t.id !== task.id);
          persistAndRerender(cat);
        });
      }
    } else {
      fabAdd.style.display = "none";
      for (const task of state[cat]){
        const row = document.createElement("div");
        row.className = "rowCheck" + (task.done ? " done" : "");
        const text = document.createElement("div");
        text.className = "checkText";
        text.textContent = task.text || "(empty)";
        row.appendChild(text);
        catList.appendChild(row);
      }
    }
  }

  fabAdd.addEventListener("click", () => {
    if (mode !== MODE.PLAN) return;
    if (!currentCat) return;
    if (state[currentCat].length >= MAX_PER_CAT) return;

    state[currentCat].push({ id: cryptoId(), text: "", done: false });
    saveState();
    renderCategory(currentCat);

    requestAnimationFrame(() => {
      const lastRow = catList.querySelector(".row:last-child");
      if (!lastRow) return;
      const tv = lastRow.querySelector(".textView");
      tv && tv.click();
    });

    renderMatrix();
  });

  function persistAndRerender(cat){
    state[cat] = state[cat].slice(0, MAX_PER_CAT);
    saveState();
    renderCategory(cat);
    renderMatrix();
  }

  function renderSettlement(){
    settleList.innerHTML = "";

    const settled = isRoundSettled();

    settleGoBtn.style.display = settled ? "none" : "inline-block";
    settleRewatchBtn.style.display = settled ? "inline-block" : "none";
    settleNewRoundText.style.display = settled ? "inline-block" : "none";

    settleGoBtn.disabled = totalTasks() === 0;
    settleRewatchBtn.disabled = !settled;

    if (!settled) {
      const snap = computeOutcomeAndCount();
      const nice = snap.outcome[0].toUpperCase() + snap.outcome.slice(1);
      settleNote.textContent = `Outcome: ${nice}.`;
    } else {
      const label = (round?.snapshot?.outcome || "fall");
      const nice = label[0].toUpperCase() + label.slice(1);
      settleNote.textContent = `Settled: ${nice}. Rewatch or New Round.`;
    }

    for (const cat of CATS){
      const tasks = state[cat];
      if (!tasks.length) continue;

      const title = document.createElement("div");
      title.className = "groupTitle";
      title.innerHTML = CAT_META[cat].title.replace("<br>", " ");
      settleList.appendChild(title);

      for (const task of tasks){
        const row = document.createElement("div");
        row.className = "rowCheck" + (task.done ? " done" : "");

        const text = document.createElement("div");
        text.className = "checkText";
        text.textContent = task.text || "(empty)";

        const sw = document.createElement("label");
        sw.className = "switch";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!task.done;
        cb.disabled = settled;

        cb.addEventListener("change", () => {
          if (settled) return;
          task.done = cb.checked;
          saveState();
          renderSettlement();
          renderMatrix();
        });

        const slider = document.createElement("span");
        slider.className = "slider";
        sw.appendChild(cb);
        sw.appendChild(slider);

        row.appendChild(text);
        row.appendChild(sw);
        settleList.appendChild(row);
      }
    }
  }

  function attachSwipeToDelete(rowEl, onDelete){
    let startX = 0;
    let currentX = 0;
    let dragging = false;

    rowEl.addEventListener("pointerdown", (e) => {
      if (mode !== MODE.PLAN) return;
      if (e.target.closest(".editInput")) return;
      dragging = true;
      startX = e.clientX;
      currentX = 0;
      rowEl.style.transition = "none";
      rowEl.setPointerCapture(e.pointerId);
    });

    rowEl.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      currentX = Math.max(-120, Math.min(0, dx));
      rowEl.style.transform = `translateX(${currentX}px)`;
    });

    rowEl.addEventListener("pointerup", () => finishSwipe());
    rowEl.addEventListener("pointercancel", () => finishSwipe());

    function finishSwipe(){
      if (!dragging) return;
      dragging = false;
      rowEl.style.transition = "transform .15s ease";

      if (currentX < -80){
        rowEl.style.transform = "translateX(-120px)";
        setTimeout(() => onDelete(), 120);
      } else {
        rowEl.style.transform = "translateX(0px)";
      }
    }
  }

  /***********************
   * WebAR start/stop
   ***********************/
  const arOverlay = document.getElementById("arOverlay");
  const arDoneBtn = document.getElementById("arDoneBtn");
  const arHint    = document.getElementById("arHint");
  const arScene   = document.getElementById("arScene");
  const arTarget0 = document.getElementById("arTarget0");

  async function startARWithSnapshot(snapshot){
    if (!arScene) return;

    buildARVisual(snapshot);

    const nice = snapshot.outcome[0].toUpperCase() + snapshot.outcome.slice(1);
    arHint.textContent = `${nice}. Point at target.`;

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    try { arScene.play && arScene.play(); } catch {}

    const sys = arScene.systems && arScene.systems["mindar-image-system"];
    if (!sys){
      arHint.textContent = "AR init failed.";
      console.error("AR init failed: mindar-image-system missing.");
      return;
    }

    try{
      await sys.start();
      try { arScene.resize && arScene.resize(); } catch {}
    }catch(e){
      arHint.textContent = "Camera blocked.";
      console.error(e);
    }
  }

  function stopAR(){
    try{
      const sys = arScene.systems && arScene.systems["mindar-image-system"];
      sys && sys.stop();
    }catch{}
  }

  if (arTarget0){
    arTarget0.addEventListener("targetFound", () => {
      if (!arHint.textContent.includes("Found")) arHint.textContent = arHint.textContent.replace("Point at target.", "Found ✅");
    });
    arTarget0.addEventListener("targetLost",  () => {
      const t = arHint.textContent;
      if (t.includes("Found")) arHint.textContent = t.replace("Found ✅", "Point at target.");
    });
  }

  /***********************
   * Buttons + Flow
   ***********************/
  const matrixViewEl = document.getElementById("matrixView");
  const catViewEl = document.getElementById("catView");
  const settleViewEl = document.getElementById("settleView");
  const mainBtnEl = document.getElementById("mainBtn");

  mainBtnEl.addEventListener("click", () => {
    if (mode === MODE.PLAN){
      if (totalTasks() === 0) return;
      for (const c of CATS) for (const t of state[c]) t.done = false;
      mode = MODE.CHECK;
      startRound();
      saveMode();
      saveState();
      showMatrix();
      return;
    }
    if (isRoundSettled()) return;
    if (totalTasks() === 0) return;
    showSettlement();
  });

  function startNewRoundFromAnywhere(){
    if (!confirm("Start a new round?")) return;

    try { stopAR(); } catch {}
    try { arOverlay.classList.remove("show"); } catch {}

    state = { IU:[], IN:[], NU:[], NN:[] };
    mode = MODE.PLAN;
    saveMode();
    saveState();
    clearRound();
    showMatrix();
  }

  newRoundBtnTop.addEventListener("click", startNewRoundFromAnywhere);
  settleNewRoundText.addEventListener("click", startNewRoundFromAnywhere);

  settleGoBtn.addEventListener("click", async () => {
    if (isRoundSettled()) return;
    if (totalTasks() === 0) return;

    const snap = computeOutcomeAndCount();

    settleRound({
      outcome: snap.outcome,
      nBalls: snap.nBalls,
      total: snap.total,
      done: snap.done,
      undone: snap.undone,
      ratio: snap.ratio,
      only2: snap.only2
    });

    arOverlay.classList.add("show");
    await startARWithSnapshot(round.snapshot);

    renderSettlement();
    renderMatrix();
  });

  settleRewatchBtn.addEventListener("click", async () => {
    if (!isRoundSettled()) return;
    if (!round?.snapshot) return;

    arOverlay.classList.add("show");
    await startARWithSnapshot(round.snapshot);
  });

  arDoneBtn.addEventListener("click", () => {
    stopAR();
    arOverlay.classList.remove("show");
    showSettlement();
  });

  // Wire remaining elements
  const catHeaderEl  = document.getElementById("catHeader");
  const catListEl    = document.getElementById("catList");
  const catPanelEl   = document.getElementById("catPanel");
  const fabAddEl     = document.getElementById("fabAdd");
  const backBtnEl    = document.getElementById("backBtn");
  const settleBackBtnEl = document.getElementById("settleBackBtn");

  // already used ids above; just ensure listeners are set
  backBtnEl.addEventListener("click", showMatrix);
  settleBackBtnEl.addEventListener("click", showMatrix);

  // initial render
  showMatrix();
</script>
</body>
</html>